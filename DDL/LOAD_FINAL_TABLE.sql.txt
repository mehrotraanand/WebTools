-- FOR EACH SET OF DATA ENTERED IN DREF_URL_EXTRACT_MASTER
-- CREATE FINAL TABLE AS SHOWN BELOW AND LOAD_PROCEDURE AS SHOWN

-- STAGE TABLE
 CREATE TABLE "STAGE_TABLE" 
   (	"VAR1" VARCHAR2(200 BYTE), 
	"VAR2" VARCHAR2(200 BYTE), 
	"VAR3" VARCHAR2(200 BYTE), 
	"VAR4" VARCHAR2(200 BYTE), 
	"VAR5" VARCHAR2(200 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;


-- FINAL TABLE
  CREATE TABLE "FINAL_TABLE" 
   (	"PRIMARY_KEY1" VARCHAR2(20 BYTE) NOT NULL ENABLE, 
	"DATA_DATE" DATE NOT NULL ENABLE, 
	"PRICE" NUMBER NOT NULL ENABLE, 
	"HIGH_PRICE" NUMBER NOT NULL ENABLE, 
	"LOW_PRICE" NUMBER NOT NULL ENABLE, 
	"CLOSE_PRICE" NUMBER NOT NULL ENABLE, 
	 CONSTRAINT "FINAL_TABLE_PK" PRIMARY KEY ("PRIMARY_KEY1", "DATA_DATE")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;


-- THIS IS SAMPLE LOAD PROCEDURE THAT LOADS DATA FROM STAGE TABLE TO FINAL TABLE
create or replace NONEDITIONABLE PROCEDURE LOAD_<FINAL_TABLE_NAME>
(
  I_PRIMARY_KEY_PARAM IN VARCHAR2 
) AS 
BEGIN
 
  INSERT INTO <FINAL_TABLE_NAME>
  SELECT I_PRIMARY_KEY_PARAM, 
         TO_DATE(VAR1,'DD/MM/YYYY'), -- ASSUMING STAGE TABLE COLUMN IS DATE
         TO_NUMBER(VAR2, '999999.9'),-- ASSUMING STAGE TABLE COLUMN IS NUMBER
         TO_NUMBER(VAR3, '999999.9'),-- ASSUMING STAGE TABLE COLUMN IS NUMBER
         TO_NUMBER(VAR4, '999999.9'),-- ASSUMING STAGE TABLE COLUMN IS NUMBER
         TO_NUMBER(VAR5, '999999.9')-- ASSUMING STAGE TABLE COLUMN IS NUMBER
  FROM <STAGE_TABLE_NAME> A
  WHERE NOT EXISTS ( SELECT 1 FROM <FINAL_TABLE_NAME> B  -- INSERT IF RECORD FOR PRIMARY KEY DOES NOT EXISTS
                    WHERE B.PRIMARY_KEY1 = I_PRIMARY_KEY_PARAM
                    AND   B.DATA_DATE = TO_DATE(VAR1,'DD/MM/YYYY'))
                   );
 END LOAD_FINAL_TABLE;